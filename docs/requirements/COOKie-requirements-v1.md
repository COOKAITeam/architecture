# COOKie - Functional and Non-Functional Requirements Specification

> **Версия документа**: 1.0
> **Дата последнего обновления**: 2025-10-13
> **Итерация**: MVP + Future Roadmap
> **Целевой регион**: СНГ (РФ, Беларусь, Казахстан)
> **Статус**: Архитектурное проектирование

---

## Оглавление

1. [Введение](#1-введение)
2. [Общие требования к системе](#2-общие-требования-к-системе)
3. [Функциональные требования (MVP)](#3-функциональные-требования-mvp)
4. [Функциональные требования (Future)](#4-функциональные-требования-future)
5. [Нефункциональные требования](#5-нефункциональные-требования)
6. [Требования к данным](#6-требования-к-данным)
7. [Требования к интеграциям](#7-требования-к-интеграциям)
8. [Требования к безопасности](#8-требования-к-безопасности)
9. [Требования к пользовательскому интерфейсу](#9-требования-к-пользовательскому-интерфейсу)
10. [Метрики и аналитика](#10-метрики-и-аналитика)

---

## 1. Введение

### 1.1. Цель документа

Данный документ определяет полный набор функциональных и нефункциональных требований к платформе COOKie для обеспечения разработки MVP и последующих итераций продукта.

### 1.2. Scope (Охват)

Документ покрывает:
- Функциональные требования к MVP (месяцы 1-6)
- Функциональные требования к будущим фазам (месяцы 7-36)
- Нефункциональные требования (производительность, масштабируемость, безопасность)
- Требования к интеграциям с внешними системами
- Требования к аналитике и метрикам

### 1.3. Терминология

| Термин | Определение |
|--------|-------------|
| MVP | Minimum Viable Product - минимально жизнеспособный продукт (Recipe Service + Parser + Enrichment + Analytics) |
| КБЖУ | Калории, Белки, Жиры, Углеводы |
| ПП | Правильное питание |
| B2C | Business-to-Consumer (пользовательский сегмент) |
| B2B | Business-to-Business (партнерский сегмент) |
| UGC | User-Generated Content (пользовательский контент) |
| LLM | Large Language Model (большая языковая модель) |

---

## 2. Общие требования к системе

### 2.1. Бизнес-цели

**BC-001**: Система должна обеспечивать привлечение 5,000 пользователей в первые 6 месяцев (MVP).

**BC-002**: Система должна обеспечивать конверсию 8-15% пользователей в платные тарифы Premium/Pro к концу года 1.

**BC-003**: Система должна поддерживать интеграцию с минимум 2 крупными ритейлерами к концу года 1.

### 2.2. Пользовательские роли

| Роль | Описание | Права |
|------|----------|-------|
| **Anonymous User** | Незарегистрированный пользователь | Просмотр главной страницы, 3 рецепта/день |
| **Free User** | Зарегистрированный пользователь | Поиск, просмотр до 20 рецептов/день, базовый КБЖУ |
| **Premium User** | Подписчик тарифа Premium (399₽/мес) | Безлимитный доступ, ИИ-диетолог, планировщик питания |
| **Pro User** | Подписчик тарифа Pro (699₽/мес) | Все функции Premium + интеграция с доставкой |
| **Content Moderator** | Модератор контента | Модерация рецептов, управление UGC |
| **Admin** | Администратор системы | Полный доступ ко всем функциям |
| **Partner Manager** | Представитель B2B партнера | Управление каталогом готовой еды, аналитика заказов |

---

## 3. Функциональные требования (MVP)

### 3.1. Recipe Service (FR-RS)

#### FR-RS-001: Управление рецептами

**Приоритет**: CRITICAL

**Описание**: Система должна обеспечивать полный жизненный цикл управления рецептами.

**Детальные требования**:

**FR-RS-001.1**: Система должна хранить следующие атрибуты рецепта:
- Основные: ID (UUID), slug (URL-friendly), название, описание
- Временные: время подготовки, время готовки, общее время
- Классификация: кухня (география), временная эпоха, сложность (1-5)
- Диета: диетические теги (массив), аллергены (массив)
- Нутриенты: КБЖУ на порцию, КБЖУ на 100г, микронутриенты (JSONB)
- Метаданные: рейтинг (средний), количество оценок, количество просмотров
- Контент: инструкции (JSON шагов), изображения (массив URL), история блюда
- Модерация: статус (draft/review/published/rejected), модератор, дата модерации
- Источник: source_url, source_type (site/video/app/ugc)

**FR-RS-001.2**: Система должна поддерживать версионирование рецептов при редактировании.

**FR-RS-001.3**: Система должна автоматически генерировать slug из названия рецепта (транслитерация для кириллицы).

**FR-RS-001.4**: Система должна валидировать полноту обязательных полей перед публикацией:
- Минимум 3 ингредиента
- Минимум 3 шага инструкций
- Присутствие минимум 1 изображения
- Заполненность КБЖУ

#### FR-RS-002: Поиск и фильтрация рецептов

**Приоритет**: CRITICAL

**Описание**: Система должна обеспечивать продвинутый поиск с множественными фильтрами.

**Детальные требования**:

**FR-RS-002.1**: Полнотекстовый поиск:
- Поиск по названию и описанию рецепта
- Поддержка русской и английской морфологии
- Поиск с учетом синонимов ингредиентов
- Поиск с автодополнением (suggest)
- Поиск с исправлением опечаток (did you mean?)

**FR-RS-002.2**: Фильтрация:
- По времени приготовления (диапазон 0-300 минут)
- По сложности (1-5)
- По диетическим тегам (множественный выбор с логикой AND/OR)
- По аллергенам (исключение из результатов)
- По КБЖУ (диапазоны для каждого показателя)
- По кухне/региону (множественный выбор)
- По временной эпохе (древние, средневековые, современные)
- По ценовому сегменту (низкий, средний, высокий)
- По наличию ингредиентов (включение/исключение списка)

**FR-RS-002.3**: Сортировка результатов:
- По релевантности (default для текстового поиска)
- По популярности (view_count + favorite_count)
- По рейтингу (rating_avg DESC, rating_count DESC)
- По времени публикации (новизна)
- По времени приготовления (от меньшего к большему)
- По сложности (от простого к сложному)

**FR-RS-002.4**: Пагинация:
- Размер страницы: 20 рецептов (настраиваемый до 50)
- Cursor-based pagination для бесконечной прокрутки
- Offset-based pagination для веб-версии

**FR-RS-002.5**: Персонализация результатов:
- Для авторизованных пользователей: учет предпочтений из профиля
- Ранжирование по истории взаимодействий (ранее просмотренные кухни/теги)

#### FR-RS-003: Карточка рецепта

**Приоритет**: HIGH

**Описание**: Система должна отображать детальную информацию о рецепте.

**Детальные требования**:

**FR-RS-003.1**: Структура карточки рецепта:
- Вкладка "Обзор": название, краткое описание, основные характеристики, изображения
- Вкладка "Ингредиенты": список с количествами, кнопка масштабирования порций
- Вкладка "Приготовление": пошаговые инструкции с таймерами
- Вкладка "КБЖУ и нутриенты": детальная таблица нутриентов на порцию и на 100г
- Вкладка "История": культурный контекст, история блюда, источники
- Вкладка "Отзывы": оценки и отзывы пользователей

**FR-RS-003.2**: Функции взаимодействия:
- Добавить в избранное (bookmark)
- Оценить рецепт (1-5 звезд)
- Написать отзыв (опционально)
- Поделиться (социальные сети, мессенджеры)
- Сохранить в PDF
- Добавить в план питания (для Premium/Pro)
- Добавить ингредиенты в список покупок

**FR-RS-003.3**: Блок "Похожие рецепты":
- Показывать 4-6 похожих рецептов по кухне/тегам
- Алгоритм: content-based filtering по ингредиентам и тегам

**FR-RS-003.4**: Трекинг взаимодействий:
- Отправлять event "recipe_view" с timestamp в Analytics Service
- Инкрементировать счетчик просмотров рецепта
- Сохранять время, проведенное на странице

#### FR-RS-004: Рейтинги и отзывы

**Приоритет**: MEDIUM

**Описание**: Система должна обеспечивать функционал оценки рецептов.

**Детальные требования**:

**FR-RS-004.1**: Оценка рецепта:
- Только авторизованные пользователи могут оценивать
- Рейтинг: 1-5 звезд (шаг 1)
- Один пользователь может оставить только одну оценку на рецепт (обновление разрешено)
- При изменении оценки пересчитывается средний рейтинг рецепта

**FR-RS-004.2**: Отзывы:
- Текстовый отзыв (опционально): до 2000 символов
- Отзыв может быть отредактирован автором в течение 24 часов
- Модерация отзывов (автоматическая фильтрация мата + ручная проверка)

**FR-RS-004.3**: Агрегация рейтингов:
- Средний рейтинг: DECIMAL(3,2) с точностью до 0.01
- Подсчет голосов: общее количество оценок
- Отображение распределения (5★: 60%, 4★: 25%, ...)

**FR-RS-004.4**: Helpful votes для отзывов:
- Пользователи могут отмечать отзывы как "полезные"
- Сортировка отзывов по количеству helpful votes

#### FR-RS-005: Управление ингредиентами

**Приоритет**: HIGH

**Описание**: Система должна управлять справочником ингредиентов.

**Детальные требования**:

**FR-RS-005.1**: Атрибуты ингредиента:
- Основные: ID, название, нормализованное название
- Классификация: категория (овощи, мясо, крупы, молочные, и т.д.)
- Нутриенты: КБЖУ на 100г, микронутриенты (витамины, минералы)
- Аллергены: связанные аллергены (массив)
- Дополнительно: срок хранения, условия хранения, средняя цена за кг
- Заменители: JSON список заменителей с коэффициентом замены
- Локализация: синонимы для разных регионов СНГ
- Сезонность: массив месяцев, когда ингредиент в сезоне

**FR-RS-005.2**: Нормализация ингредиентов:
- Удаление вариаций написания ("помидоры" = "томаты" = "pomidory")
- Транслитерация и маппинг на единый ID
- Парсер количеств и единиц измерения ("2 столовые ложки" → 30ml)

**FR-RS-005.3**: API для поиска ингредиентов:
- Поиск с автодополнением
- Фильтрация по категории
- Фильтрация по аллергенам
- Получение заменителей

### 3.2. Parser Service (FR-PS)

#### FR-PS-001: Парсинг рецептов с сайтов

**Приоритет**: CRITICAL

**Описание**: Система должна автоматически извлекать рецепты с внешних источников.

**Детальные требования**:

**FR-PS-001.1**: Поддерживаемые источники (MVP):
- 1000.menu
- tableofgods.com
- EdimDoma.ru (опционально)

**FR-PS-001.2**: Извлекаемые данные:
- Название рецепта
- Описание
- Изображения (минимум 1)
- Список ингредиентов с количествами и единицами
- Пошаговые инструкции
- Время приготовления (если доступно)
- Количество порций
- Первичные теги/категории (если доступны)
- URL источника (для атрибуции)

**FR-PS-001.3**: Планировщик задач:
- Начальная загрузка: массовый парсинг для формирования базы (10,000+ рецептов)
- Инкрементальное обновление: ежедневный парсинг новых рецептов
- Настраиваемая очередь с приоритетами
- Ретраи при ошибках (3 попытки с экспоненциальным backoff)
- Rate limiting по доменам (соблюдение robots.txt)

**FR-PS-001.4**: Дедупликация:
- Проверка по названию (fuzzy matching, Levenshtein distance < 3)
- Проверка по списку ингредиентов (Jaccard similarity > 0.8)
- Проверка по изображениям (perceptual hash)
- Маркировка дубликатов для ручной проверки модератором

**FR-PS-001.5**: Валидация извлеченных данных:
- Проверка наличия минимум 3 ингредиентов
- Проверка наличия минимум 3 шагов
- Проверка формата количеств (парсинг успешен)
- Проверка валидности URL изображений
- Оценка полноты данных (score 0-100%)

**FR-PS-001.6**: Обработка ошибок:
- Логирование неуспешных попыток парсинга
- Очередь для ручной проверки проблемных страниц
- Уведомления администраторам при критических ошибках

#### FR-PS-002: Парсинг видео-рецептов

**Приоритет**: LOW (Future enhancement)

**Описание**: Система должна извлекать рецепты из видео-контента.

**Детальные требования**:

**FR-PS-002.1**: Поддерживаемые платформы:
- YouTube (через YouTube Data API)
- TikTok (через API, если доступен)
- Instagram Reels (скрапинг)

**FR-PS-002.2**: Извлечение данных:
- Метаданные видео (название, описание, теги)
- Транскрипция аудио (ASR - Automatic Speech Recognition)
- Извлечение ингредиентов из транскрипции (NLP)
- Ключевые кадры (Computer Vision для определения шагов)

**FR-PS-002.3**: Обработка транскрипций:
- Распознавание речи через Yandex SpeechKit / Google Speech-to-Text
- NER (Named Entity Recognition) для извлечения ингредиентов и количеств
- Структурирование шагов по временным меткам

### 3.3. Data Enrichment Service (FR-DE)

#### FR-DE-001: Нормализация единиц измерения

**Приоритет**: CRITICAL

**Описание**: Система должна конвертировать все единицы измерения в метрическую систему.

**Детальные требования**:

**FR-DE-001.1**: Справочник единиц измерения:
- Объем: литры (л), миллилитры (мл), стаканы (250мл), столовые ложки (15мл), чайные ложки (5мл)
- Вес: килограммы (кг), граммы (г), фунты (453.6г), унции (28.35г)
- Штучные: штуки (шт), головки, пучки
- Специфичные: щепотка (1г), долька, зубчик

**FR-DE-001.2**: Конвертация:
- Все единицы конвертируются в граммы (г) или миллилитры (мл)
- Для штучных ингредиентов: использовать среднюю массу/объем
- Хранение оригинальной единицы для отображения пользователю

**FR-DE-001.3**: Обработка неопределенностей:
- "По вкусу" → optional ingredient
- "Несколько штук" → среднее значение с флагом uncertainty
- Отсутствие количества → установка default по типу ингредиента

#### FR-DE-002: Автоматический расчет КБЖУ

**Приоритет**: CRITICAL

**Описание**: Система должна рассчитывать КБЖУ рецепта на основе ингредиентов.

**Детальные требования**:

**FR-DE-002.1**: Источники данных по нутриентам:
- USDA FoodData Central (для международных продуктов)
- База данных Роспотребнадзора (для локальных продуктов)
- Собственная БД с приоритетом локальных данных

**FR-DE-002.2**: Расчет на порцию:
- Суммирование КБЖУ всех ингредиентов (с учетом количеств)
- Деление на количество порций
- Округление до целых для калорий, до 0.1г для БЖУ

**FR-DE-002.3**: Расчет на 100г:
- Общий вес блюда = сумма весов всех ингредиентов
- Пропорциональный пересчет КБЖУ на 100г
- Учет потери влаги при термообработке (опционально, коэффициенты по типу готовки)

**FR-DE-002.4**: Микронутриенты:
- Расчет витаминов (A, B1, B2, B6, B12, C, D, E, K)
- Расчет минералов (Ca, Fe, Mg, P, K, Na, Zn)
- Расчет клетчатки, сахаров, насыщенных жиров

**FR-DE-002.5**: Качество данных:
- Флаг "estimated" для рецептов с неполными данными по ингредиентам
- Confidence score (0-100%) для расчета КБЖУ

#### FR-DE-003: Автоматическая классификация рецептов

**Приоритет**: MEDIUM

**Описание**: Система должна автоматически присваивать теги и категории рецептам.

**Детальные требования**:

**FR-DE-003.1**: Классификация по кухне:
- ML-модель на основе названия рецепта и ингредиентов
- Словарь ключевых слов для простых случаев ("паста" → Итальянская кухня)
- Поддержка множественной принадлежности (фьюжн)

**FR-DE-003.2**: Определение диетических тегов:
- Веган: отсутствие мяса, рыбы, молочных продуктов, яиц, меда
- Вегетарианец: отсутствие мяса и рыбы
- Безглютеновый: отсутствие пшеницы, ржи, ячменя
- Кето: КБЖУ соответствие (высокие жиры, низкие углеводы)
- Палео: исключение зерновых, бобовых, молочных

**FR-DE-003.3**: Определение аллергенов:
- Автоматическая маркировка по ингредиентам
- Поддерживаемые аллергены: глютен, молоко, яйца, орехи, соя, рыба/морепродукты, кунжут

**FR-DE-003.4**: Временная эпоха:
- Парсинг из поля "история" (если заполнено)
- Ключевые слова для автоматической классификации
- Default: "contemporary" для рецептов без истории

### 3.4. Analytics Service (FR-AN)

#### FR-AN-001: Сбор событий пользователей

**Приоритет**: HIGH

**Описание**: Система должна собирать события для анализа поведения пользователей.

**Детальные требования**:

**FR-AN-001.1**: Типы событий (MVP):
- `recipe_search`: поисковый запрос, фильтры, количество результатов
- `recipe_view`: просмотр рецепта, время на странице
- `recipe_favorite`: добавление/удаление из избранного
- `recipe_rate`: оценка рецепта
- `recipe_share`: шаринг рецепта
- `user_signup`: регистрация нового пользователя
- `user_login`: вход пользователя
- `subscription_start`: начало подписки (Premium/Pro)
- `subscription_cancel`: отмена подписки

**FR-AN-001.2**: Атрибуты события:
- event_id (UUID)
- user_id (UUID, null для анонимных)
- session_id (UUID)
- event_type (VARCHAR)
- event_data (JSONB) - специфичные данные события
- device_type (web/ios/android)
- ip_address (INET)
- user_agent (TEXT)
- created_at (TIMESTAMP)

**FR-AN-001.3**: Механизм сбора:
- Асинхронная отправка через message queue (Kafka)
- Батчинг событий с клиента (до 10 событий или 30 секунд)
- Гарантия доставки (at-least-once semantic)

**FR-AN-001.4**: Хранилище:
- ClickHouse для событий (колоночная БД, эффективная для аналитики)
- Партиционирование по дате (месяц)
- Retention policy: 2 года для детальных событий, агрегаты - бессрочно

#### FR-AN-002: Метрики продукта

**Приоритет**: HIGH

**Описание**: Система должна рассчитывать ключевые продуктовые метрики.

**Детальные требования**:

**FR-AN-002.1**: Пользовательские метрики:
- DAU (Daily Active Users): уникальные пользователи за день
- WAU (Weekly Active Users): уникальные пользователи за неделю
- MAU (Monthly Active Users): уникальные пользователи за месяц
- Retention Rate: D1, D7, D30 (процент вернувшихся пользователей)
- Churn Rate: процент отписавшихся пользователей (для платных)
- LTV (Lifetime Value): средний доход с пользователя за весь период
- CAC (Customer Acquisition Cost): стоимость привлечения пользователя

**FR-AN-002.2**: Метрики рецептов:
- Популярность: view_count, unique_views
- Вовлеченность: favorite_count, rating_count
- Конверсия: просмотр → добавление в избранное (%)
- Время на странице: среднее время просмотра рецепта
- Bounce rate: процент пользователей, покинувших страницу сразу

**FR-AN-002.3**: Метрики поиска:
- Популярные поисковые запросы (топ-100)
- Конверсия поиска: запрос → клик по результату (CTR)
- Распределение использования фильтров
- Нулевые результаты: процент запросов без результатов

**FR-AN-002.4**: Бизнес-метрики:
- MRR (Monthly Recurring Revenue): ежемесячная повторяющаяся выручка
- ARPU (Average Revenue Per User): средний доход на пользователя
- ARPPU (Average Revenue Per Paying User): средний доход на платящего пользователя
- Conversion Rate: Free → Premium, Free → Pro
- Subscription renewal rate: процент продлений подписки

#### FR-AN-003: Отчетность

**Приоритет**: MEDIUM

**Описание**: Система должна генерировать регулярные отчеты.

**Детальные требования**:

**FR-AN-003.1**: Еженедельные отчеты (MVP):
- Основные метрики: DAU/WAU/MAU, новые пользователи
- Топ-10 рецептов по просмотрам
- Топ-10 поисковых запросов
- Конверсионные метрики (поиск → просмотр → избранное)
- Распределение активности по времени суток

**FR-AN-003.2**: Ежемесячные отчеты:
- Детальные метрики retention
- Анализ когорт (cohort analysis)
- Источники трафика (UTM-метки)
- Географическое распределение пользователей
- Распределение по кухням, диетам, категориям

**FR-AN-003.3**: Формат отчетов:
- PDF для email-рассылки
- Интерактивные дашборды (Grafana)
- CSV-экспорт для дополнительной обработки

**FR-AN-003.4**: A/B тестирование:
- Механизм распределения пользователей по тестовым группам (buckets)
- Сбор метрик по группам
- Расчет статистической значимости (p-value)
- Интерфейс для настройки тестов (без кода)

### 3.5. User Service (FR-US)

#### FR-US-001: Регистрация и аутентификация

**Приоритет**: CRITICAL

**Описание**: Система должна обеспечивать безопасную регистрацию и вход пользователей.

**Детальные требования**:

**FR-US-001.1**: Способы регистрации:
- Email + пароль (первичный способ)
- OAuth 2.0 через Yandex ID
- OAuth 2.0 через VK ID
- OAuth 2.0 через Google (опционально)

**FR-US-001.2**: Валидация при регистрации:
- Email: проверка формата, проверка уникальности
- Пароль: минимум 8 символов, наличие букв и цифр
- Username (опционально): 3-30 символов, уникальность

**FR-US-001.3**: Подтверждение email:
- Отправка письма с ссылкой подтверждения
- Токен действителен 24 часа
- Повторная отправка письма (не чаще 1 раза в 5 минут)

**FR-US-001.4**: Аутентификация:
- JWT токены (access token + refresh token)
- Access token: время жизни 15 минут
- Refresh token: время жизни 30 дней, хранится в HttpOnly cookie
- Автоматическое обновление access token через refresh token

**FR-US-001.5**: Восстановление пароля:
- Запрос сброса через email
- Токен сброса действителен 1 час
- Установка нового пароля

#### FR-US-002: Профиль пользователя

**Приоритет**: HIGH

**Описание**: Система должна хранить профиль и предпочтения пользователя.

**Детальные требования**:

**FR-US-002.1**: Основная информация:
- Имя, фамилия
- Дата рождения (опционально, для расчета калорий)
- Пол (опционально)
- Аватар (загрузка изображения)

**FR-US-002.2**: Физические параметры (для Premium/Pro):
- Рост (см)
- Вес (кг)
- Уровень активности (сидячий, легкая активность, умеренная, активный, очень активный)

**FR-US-002.3**: Цели (для Premium/Pro):
- Цель: похудение, набор массы, поддержание веса, набор мышечной массы, здоровье
- Целевой вес (кг)
- Целевые калории в день (рассчитываются автоматически или задаются вручную)

**FR-US-002.4**: Диетические предпочтения:
- Тип диеты: веган, вегетарианец, пескетарианец, кето, палео, без предпочтений
- Аллергии: множественный выбор (глютен, молоко, орехи, соя, яйца, рыба, моллюски)
- Нелюбимые ингредиенты: массив UUID ингредиентов

**FR-US-002.5**: Кулинарные предпочтения:
- Любимые кухни: множественный выбор (итальянская, азиатская, русская, и т.д.)
- Уровень навыков готовки: 1-5 (начинающий → профессионал)
- Максимальное время на готовку: минут (по умолчанию: без ограничений)

#### FR-US-003: Избранное

**Приоритет**: MEDIUM

**Описание**: Пользователи должны иметь возможность сохранять рецепты в избранное.

**Детальные требования**:

**FR-US-003.1**: Добавление в избранное:
- Кнопка "Добавить в избранное" на карточке рецепта
- Визуальное подтверждение (иконка закрашивается)
- Отправка события в Analytics

**FR-US-003.2**: Управление избранным:
- Просмотр списка избранных рецептов
- Фильтрация и сортировка избранного
- Удаление из избранного
- Группировка в коллекции (Future: создание пользовательских папок)

**FR-US-003.3**: Лимиты:
- Free: до 50 избранных рецептов
- Premium/Pro: без ограничений

---

## 4. Функциональные требования (Future)

### 4.1. AI Nutritionist Service (FR-AI)

#### FR-AI-001: Чат-консультант по питанию

**Приоритет**: HIGH (Phase 2, месяцы 7-12)

**Описание**: ИИ-диетолог для консультаций пользователей.

**Детальные требования**:

**FR-AI-001.1**: Интеграция с LLM:
- Основной провайдер: OpenAI GPT-4
- Резервный: Anthropic Claude
- Контекст: профиль пользователя, история запросов, база рецептов

**FR-AI-001.2**: Типы запросов:
- Рекомендации рецептов по параметрам
- Советы по замене ингредиентов
- Объяснение пользы/вреда продуктов
- Расчет индивидуальных норм КБЖУ
- Советы по оптимизации рациона

**FR-AI-001.3**: Лимиты:
- Free: 5 запросов в месяц
- Premium: без ограничений
- Pro: без ограничений + приоритетная обработка

**FR-AI-001.4**: Безопасность и этика:
- Дисклеймер: "Не заменяет консультацию врача"
- Фильтрация медицинских советов (только общая информация)
- Модерация запросов (запрет опасных диет)

#### FR-AI-002: Персонализированные рекомендации

**Приоритет**: HIGH (Phase 2)

**Описание**: Автоматические рекомендации рецептов на основе ML.

**Детальные требования**:

**FR-AI-002.1**: Алгоритмы рекомендаций:
- Collaborative filtering: рекомендации на основе похожих пользователей
- Content-based filtering: рекомендации по ингредиентам и тегам
- Hybrid approach: комбинация обоих подходов

**FR-AI-002.2**: Факторы ранжирования:
- История просмотров и избранного
- Профиль пользователя (предпочтения, аллергии)
- Цели (КБЖУ, диета)
- Популярность рецепта
- Сезонность ингредиентов
- Время суток (завтрак/обед/ужин)

**FR-AI-002.3**: Обучение модели:
- Начальный этап: использование базовых правил + content-based
- После накопления данных: обучение ML-модели на истории взаимодействий
- Ребалансировка модели: еженедельно

**FR-AI-002.4**: A/B тестирование:
- Постоянное тестирование различных алгоритмов
- Метрики: CTR, конверсия в просмотр, время на странице

### 4.2. Meal Planning Service (FR-MP)

#### FR-MP-001: Автоматическое планирование питания

**Приоритет**: HIGH (Phase 2, месяцы 7-12)

**Описание**: Генерация плана питания на заданный период.

**Детальные требования**:

**FR-MP-001.1**: Параметры планирования:
- Период: день, неделя (по умолчанию), 2 недели, месяц
- Количество приемов пищи: 3-6 в день
- Целевые КБЖУ: автоматически из профиля или заданные вручную
- Разнообразие: коэффициент повторяемости блюд (0-100%)
- Бюджет: низкий, средний, высокий (фильтр по price_segment)

**FR-MP-001.2**: Алгоритм генерации:
- Получение целевых КБЖУ из профиля пользователя
- Распределение калорий по приемам пищи (завтрак 25%, обед 35%, ужин 30%, снеки 10%)
- Подбор рецептов с учетом ограничений (аллергии, диета, нелюбимые ингредиенты)
- Оптимизация по КБЖУ (линейное программирование или жадный алгоритм)
- Балансировка нутриентов (витамины, минералы)
- Учет разнообразия (избегание повторений ингредиентов и кухонь)

**FR-MP-001.3**: Ручная корректировка:
- Замена любого приема пищи альтернативным рецептом
- Изменение количества порций
- Добавление/удаление приемов пищи

**FR-MP-001.4**: Визуализация плана:
- Календарный вид (неделя)
- Список покупок (автоматическая генерация)
- Сводка КБЖУ по дням и за весь период
- Оценка стоимости

#### FR-MP-002: Список покупок

**Приоритет**: MEDIUM (Phase 2)

**Описание**: Автоматическая генерация списка покупок из плана питания.

**Детальные требования**:

**FR-MP-002.1**: Генерация списка:
- Агрегация всех ингредиентов из рецептов плана
- Суммирование одинаковых ингредиентов
- Конвертация единиц измерения (все в граммы/литры)
- Группировка по категориям (овощи, мясо, молочные, и т.д.)

**FR-MP-002.2**: Расчет стоимости:
- Использование средних цен из базы ингредиентов
- Расчет примерной стоимости списка
- Отображение диапазона (min-max) для вариативных цен

**FR-MP-002.3**: Функции управления списком:
- Отметить ингредиент как купленный (checkbox)
- Добавить свои позиции вручную
- Экспортировать в разных форматах (PDF, CSV, TXT)
- Отправить список на email

**FR-MP-002.4**: Интеграция с ритейлерами (для Pro):
- Кнопка "Заказать через [Партнер]"
- Перенос списка покупок в корзину партнера (API интеграция)
- Отслеживание статуса заказа

### 4.3. Order Service (FR-OR)

#### FR-OR-001: Заказ готовой еды

**Приоритет**: MEDIUM (Phase 3, год 2)

**Описание**: Интеграция с ритейлерами для заказа готовой еды.

**Детальные требования**:

**FR-OR-001.1**: Партнеры (планируемые):
- X5 Group (Пятерочка, Перекресток)
- ВкусВилл
- Сбермаркет
- Самокат

**FR-OR-001.2**: Каталог готовой еды партнеров:
- Синхронизация каталогов через API (ежедневная)
- Маппинг блюд на рецепты COOKie (по КБЖУ и ингредиентам)
- Фильтрация по диетическим предпочтениям пользователя
- Отображение цены, доступности, времени доставки

**FR-OR-001.3**: Процесс заказа:
- Выбор партнера
- Добавление блюд в корзину
- Интеграция с корзиной партнера через API
- Редирект на сайт/приложение партнера для оформления заказа
- Webhook от партнера о статусе заказа

**FR-OR-001.4**: Бизнес-модель:
- Комиссия с транзакции: 3-7% (согласно договору с партнером)
- Отслеживание конверсии: клик → добавление в корзину → заказ
- Аналитика для партнеров: популярные блюда, средний чек, конверсия

---

## 5. Нефункциональные требования

### 5.1. Производительность (NFR-PF)

**NFR-PF-001**: API latency
- P50 (медиана): ≤ 200ms
- P95: ≤ 500ms
- P99: ≤ 1000ms

**NFR-PF-002**: Поиск рецептов
- Время ответа для поиска с фильтрами: P95 ≤ 300ms

**NFR-PF-003**: Загрузка карточки рецепта
- Полная загрузка (с изображениями): P95 ≤ 2000ms
- Time to First Byte (TTFB): ≤ 500ms

**NFR-PF-004**: Пропускная способность
- MVP: 100 запросов в секунду (RPS)
- Year 1: 500 RPS
- Year 2: 2000 RPS

**NFR-PF-005**: Оптимизация изображений
- Формат: WebP для веб, JPEG для fallback
- Размеры: thumbnail (200x200), medium (600x400), large (1200x800)
- Lazy loading для изображений вне viewport

### 5.2. Масштабируемость (NFR-SC)

**NFR-SC-001**: Горизонтальная масштабируемость
- Все микросервисы должны поддерживать horizontal scaling
- Stateless сервисы (кроме сессий в Redis)

**NFR-SC-002**: Автоматическое масштабирование
- Kubernetes HPA (Horizontal Pod Autoscaler):
  - Recipe Service: CPU > 70% → scale up
  - Parser Service: Queue depth > 100 → scale up
  - API Gateway: Request rate > 1000 RPS → scale up

**NFR-SC-003**: Масштабирование баз данных
- PostgreSQL: Read replicas для Recipe DB и User DB
- ClickHouse: Sharding для Analytics DB (2+ шарда)
- Redis: Redis Cluster с репликацией (3 ноды)

**NFR-SC-004**: Целевые объемы данных
- Year 1: 10,000 рецептов, 5,000 пользователей
- Year 2: 50,000 рецептов, 25,000 пользователей
- Year 3: 100,000 рецептов, 80,000 пользователей

### 5.3. Доступность (NFR-AV)

**NFR-AV-001**: Uptime SLO
- MVP: 99.5% (43 минуты downtime в месяц)
- Year 1+: 99.9% (43 минуты downtime в месяц)

**NFR-AV-002**: Отказоустойчивость
- Репликация критичных БД (PostgreSQL primary + replica)
- Резервные копии БД: ежедневные (retention 30 дней)
- Disaster recovery: RTO < 4 часа, RPO < 1 час

**NFR-AV-003**: Graceful degradation
- При недоступности Analytics Service: события буферизуются
- При недоступности Cache: fallback на БД
- При недоступности Parser Service: очередь накапливается

**NFR-AV-004**: Health checks
- Все сервисы должны экспонировать /health endpoint
- Kubernetes liveness и readiness probes
- Мониторинг health checks через Prometheus

### 5.4. Безопасность (NFR-SEC)

**NFR-SEC-001**: Аутентификация и авторизация
- JWT токены для аутентификации
- RBAC (Role-Based Access Control) для авторизации
- OAuth 2.0 для внешних провайдеров

**NFR-SEC-002**: Шифрование
- HTTPS для всех API endpoints (TLS 1.3)
- Шифрование паролей: bcrypt (cost factor 12)
- Шифрование чувствительных данных в БД: AES-256

**NFR-SEC-003**: Rate limiting
- API Gateway: 1000 запросов/час на IP для анонимных
- API Gateway: 5000 запросов/час на пользователя для авторизованных
- ИИ-диетолог: 5 запросов/месяц для Free, unlimited для Premium/Pro

**NFR-SEC-004**: Защита от атак
- CORS: whitelist доменов
- CSRF protection для форм
- XSS protection: санитизация пользовательского ввода
- SQL injection: использование parameterized queries (ORM)

**NFR-SEC-005**: Аудит
- Логирование всех изменений данных (audit log)
- Логирование аутентификации и авторизации
- Retention: 1 год для audit logs

### 5.5. Наблюдаемость (NFR-OBS)

**NFR-OBS-001**: Мониторинг метрик
- Prometheus для сбора метрик со всех сервисов
- Grafana для визуализации
- Метрики: latency, throughput, error rate, resource usage

**NFR-OBS-002**: Логирование
- Структурированные логи (JSON format)
- ELK Stack (Elasticsearch, Logstash, Kibana)
- Log levels: ERROR, WARN, INFO, DEBUG
- Retention: 30 дней для DEBUG, 90 дней для INFO/WARN, 1 год для ERROR

**NFR-OBS-003**: Трассировка (Tracing)
- Distributed tracing: Jaeger или Zipkin
- Trace ID передается через все микросервисы
- Корреляция логов и трейсов

**NFR-OBS-004**: Алертинг
- Критические алерты (PagerDuty / Telegram):
  - API error rate > 1%
  - Latency P99 > 3s
  - Database connection pool exhausted
- Предупреждающие алерты (Email / Slack):
  - Latency P95 > 1s
  - Disk usage > 80%
  - Queue depth > 500

**NFR-OBS-005**: Отслеживание ошибок
- Sentry для frontend и backend
- Source maps для JS (production)
- Automatic error grouping и deduplication

### 5.6. Локализация и интернационализация (NFR-L10N)

**NFR-L10N-001**: Языки (MVP)
- Русский язык (основной)
- Английский язык (для интерфейса, опционально)

**NFR-L10N-002**: Локализация контента
- Рецепты: приоритет на русскоязычные источники
- Ингредиенты: синонимы для разных регионов СНГ (Россия, Беларусь, Казахстан)
- Единицы измерения: метрическая система (граммы, литры)

**NFR-L10N-003**: Временные зоны
- Хранение всех timestamp в UTC
- Отображение в локальном времени пользователя

**NFR-L10N-004**: Валюты
- Основная валюта: RUB (российский рубль)
- Поддержка альтернативных валют (для будущих регионов): BYN, KZT, USD

### 5.7. Совместимость (NFR-COMP)

**NFR-COMP-001**: Поддержка браузеров (Web)
- Chrome: последние 2 версии
- Firefox: последние 2 версии
- Safari: последние 2 версии
- Edge: последние 2 версии
- Мобильные браузеры: iOS Safari 14+, Chrome Mobile 90+

**NFR-COMP-002**: Поддержка мобильных платформ (Native App)
- iOS: 14.0+
- Android: 8.0+ (API level 26+)

**NFR-COMP-003**: Адаптивность (Responsive Design)
- Breakpoints: 320px (mobile), 768px (tablet), 1024px (desktop), 1440px (wide)
- Mobile-first подход

---

## 6. Требования к данным

### 6.1. Модель данных рецепта (DR-REC)

См. Enhanced Database Schema: [enhanced_database_schema.puml](diagrams/enhanced_database_schema.puml)

Ключевые сущности:
- `recipes`: основная таблица рецептов
- `ingredients`: справочник ингредиентов
- `recipe_ingredients`: связь многие-ко-многим
- `categories`: иерархические категории
- `tags`: теги для классификации

### 6.2. GDPR и защита персональных данных (DR-GDPR)

**DR-GDPR-001**: Согласие на обработку
- Явное согласие пользователя при регистрации
- Возможность отозвать согласие

**DR-GDPR-002**: Право на забвение
- Пользователь может удалить аккаунт
- Удаление всех персональных данных (email, имя, аватар)
- Анонимизация созданного контента (рецепты → author_id = null)

**DR-GDPR-003**: Право на экспорт данных
- Экспорт профиля, избранного, истории в JSON

**DR-GDPR-004**: Минимизация данных
- Сбор только необходимых данных
- Опциональность полей (дата рождения, физические параметры)

### 6.3. Резервное копирование (DR-BACKUP)

**DR-BACKUP-001**: Частота бэкапов
- PostgreSQL: Continuous WAL archiving + daily full backup
- Redis: RDB snapshots каждые 6 часов
- ClickHouse: incremental backups каждые 24 часа

**DR-BACKUP-002**: Хранение бэкапов
- S3-compatible storage
- Retention: 30 дней для полных бэкапов, 7 дней для инкрементальных

**DR-BACKUP-003**: Тестирование восстановления
- Ежемесячные тесты восстановления из бэкапов
- Проверка целостности данных

---

## 7. Требования к интеграциям

### 7.1. Внешние API (INT-API)

**INT-API-001**: OpenAI / Anthropic Claude
- Назначение: ИИ-диетолог, чат-консультант
- Endpoint: OpenAI Chat Completion API
- Rate limit: отслеживание лимитов провайдера
- Fallback: переключение на Anthropic при недоступности OpenAI

**INT-API-002**: Платежный шлюз (ЮKassa)
- Назначение: обработка подписок и платежей (Phase 2)
- Поддержка методов: банковские карты, СБП, Apple Pay, Google Pay, ЮMoney
- Webhooks: уведомления о статусе платежа
- API Documentation: https://yookassa.ru/developers/api
- Преимущества: лучшая поддержка российского рынка, низкие комиссии, простая интеграция
- **Примечание**: Для MVP платежи не требуются (все функции бесплатны)

**INT-API-003**: Email (SendGrid / Mailgun)
- Назначение: transactional emails (подтверждение, уведомления)
- Templates: использование готовых шаблонов
- Rate limit: соблюдение лимитов провайдера

**INT-API-004**: SMS (SMSC.ru / Twilio)
- Назначение: верификация номера телефона (опционально), критичные уведомления
- Использование: ограниченное (дорого)

**INT-API-005**: Push Notifications (Firebase Cloud Messaging)
- Назначение: push-уведомления для мобильных приложений
- Поддержка: iOS и Android

**INT-API-006**: Ритейлеры (Future, Phase 3)
- X5 Group API: каталог готовой еды, создание заказов
- ВкусВилл API: каталог, заказы
- Сбермаркет API: каталог, заказы
- Webhook endpoints для статусов заказов

### 7.2. Требования к API интеграциям (INT-REQ)

**INT-REQ-001**: Надежность
- Retry logic: 3 попытки с экспоненциальным backoff
- Circuit breaker: отключение интеграции при частых ошибках
- Fallback: резервные провайдеры где возможно

**INT-REQ-002**: Безопасность
- API keys хранятся в секретах (Kubernetes Secrets / AWS Secrets Manager)
- Ротация ключей: каждые 90 дней

**INT-REQ-003**: Мониторинг
- Метрики: latency, error rate для каждой интеграции
- Алертинг при error rate > 5%

---

## 8. Требования к безопасности

См. раздел 5.4 Нефункциональные требования - Безопасность (NFR-SEC)

Дополнительно:

**SEC-001**: Пентестинг
- Ежегодный внешний пентест после выхода на рынок
- Внутренний security audit каждые 6 месяцев

**SEC-002**: Уязвимости зависимостей
- Автоматическое сканирование npm/pip зависимостей (Snyk / Dependabot)
- Патчинг критичных уязвимостей в течение 7 дней

**SEC-003**: Secrets management
- Никаких secrets в коде или git репозитории
- Использование Kubernetes Secrets / AWS Secrets Manager
- Аудит доступа к секретам

---

## 9. Требования к пользовательскому интерфейсу

### 9.1. UX принципы (UI-UX)

**UI-UX-001**: Простота и минимализм
- Чистый, современный дизайн
- Минимум кликов для выполнения действий
- Приоритет контенту (рецепты), а не декорациям

**UI-UX-002**: Mobile-first
- Разработка с приоритетом на мобильные устройства
- 70%+ пользователей ожидается с мобильных

**UI-UX-003**: Доступность (Accessibility)
- WCAG 2.1 Level AA compliance (цель)
- Поддержка screen readers
- Контрастность текста: минимум 4.5:1
- Клавиатурная навигация

**UI-UX-004**: Производительность интерфейса
- Время загрузки главной страницы: < 3s
- First Contentful Paint (FCP): < 1.5s
- Largest Contentful Paint (LCP): < 2.5s
- Cumulative Layout Shift (CLS): < 0.1

### 9.2. Ключевые экраны (UI-SCR)

**UI-SCR-001**: Главная страница
- Hero section с призывом к действию (CTA)
- Блок популярных рецептов (карусель)
- Блок категорий (grid)
- Поисковая строка (sticky header)

**UI-SCR-002**: Страница поиска
- Поисковая строка с автодополнением
- Панель фильтров (sidebar для desktop, modal для mobile)
- Grid результатов (3 колонки desktop, 1 колонка mobile)
- Pagination или infinite scroll

**UI-SCR-003**: Карточка рецепта
- Изображения (gallery с превью)
- Основная информация (время, сложность, рейтинг)
- Табы (Обзор, Ингредиенты, Приготовление, КБЖУ, История, Отзывы)
- Sticky CTA buttons (В избранное, Поделиться, Добавить в план)

**UI-SCR-004**: Профиль пользователя
- Основная информация (аватар, имя, email)
- Избранные рецепты
- История просмотров (опционально)
- Настройки профиля
- Управление подпиской

---

## 10. Метрики и аналитика

### 10.1. Продуктовые метрики (MET-PROD)

См. раздел 3.4 Analytics Service (FR-AN-002)

Дополнительно:

**MET-PROD-001**: North Star Metric
- **WAU (Weekly Active Users)** - основная метрика успеха продукта

**MET-PROD-002**: Воронка конверсии
- Незарегистрированный → Регистрация: цель 20%
- Free → Premium: цель 8-15%
- Premium → Pro: цель 3-5%

**MET-PROD-003**: Engagement метрики
- Среднее количество просмотров рецептов на пользователя в неделю: цель 10+
- Процент пользователей с минимум 1 избранным рецептом: цель 40%
- Retention D7: цель 30%, Retention D30: цель 20%

### 10.2. Технические метрики (MET-TECH)

**MET-TECH-001**: SLI (Service Level Indicators)
- Availability: 99.9%
- Latency P95: < 500ms
- Error rate: < 0.1%

**MET-TECH-002**: Инфраструктура
- CPU usage: target < 70%
- Memory usage: target < 80%
- Disk usage: target < 75%

**MET-TECH-003**: Базы данных
- PostgreSQL query time P95: < 100ms
- PostgreSQL connection pool usage: < 80%
- Redis hit rate: > 90%

---

## Приложения

### Приложение A: Глоссарий

| Термин | Определение |
|--------|-------------|
| Slug | URL-friendly идентификатор (например, "veganskaya-pasta-karbonara") |
| JSONB | Binary JSON format в PostgreSQL |
| ltree | PostgreSQL extension для хранения иерархических путей |
| Perceptual hash | Хэш изображения, устойчивый к изменениям размера и качества |
| Circuit breaker | Паттерн для предотвращения каскадных отказов при недоступности внешних сервисов |

### Приложение B: Сокращения

| Сокращение | Расшифровка |
|------------|-------------|
| MVP | Minimum Viable Product |
| SLO | Service Level Objective |
| SLI | Service Level Indicator |
| RTO | Recovery Time Objective |
| RPO | Recovery Point Objective |
| WAL | Write-Ahead Log |
| ORM | Object-Relational Mapping |
| CORS | Cross-Origin Resource Sharing |
| CSRF | Cross-Site Request Forgery |
| XSS | Cross-Site Scripting |

---

**Конец документа**
