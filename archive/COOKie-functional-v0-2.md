# COOKie — Отчет по функциональным требованиям (итерация 2, MVP)

Версия: 0.2 (MVP). Регион локализации: СНГ. Тарифная сетка — TBD (ограничения для free пользователей возможны по количеству/мощности запросов к ИИ-диетологу).

## 1. Расширенное описание сервиса рецептов (Recipe Service)

Recipe Service — первый и основной микросервис бесплатной функциональности. Отвечает за сбор, хранение, поиск и обогащение базы рецептов, ингредиентов и их метаданных для последующего использования другими сервисами (ИИ-диетолог, планировщик питания, заказы).

### 1.1. Модель данных (ключевые сущности)

- Рецепт (Recipe):
  - id (UUID)
  - title (название)
  - description (описание)
  - history (история блюда, источники/легенды)
  - cuisine_geography (географическая принадлежность кухни)
  - timeline_category (древние/средневековые/новое время/современная кухня/массовая современная)
  - difficulty_level (1–5)
  - prep_time / cook_time / total_time (минуты)
  - servings (порций)
  - instructions (JSON шаги: шаг, время, техника, инвентарь)
  - nutrition (JSON КБЖУ и нутриенты на порцию и на 100 г)
  - dietary_tags (веган, вегетарианство, кето, безглютен, халяль, кошер и др.)
  - allergens (молоко, орехи, глютен и пр.)
  - price_segment (низкий/средний/высокий, опционально)
  - rating, rating_count (агрегаты)
  - images (список URL с порядком и подписями)
  - source_url, source_type (site/video/app/UGC)
  - localization (язык контента, регион применимости)
  - moderation_status (draft/review/published)
  - created_at, updated_at

- Ингредиент (Ingredient):
  - id (UUID), name
  - category (овощи, мясо, крупы и т. п.)
  - nutrition_per_100g (КБЖУ + микро/макро-нутриенты)
  - allergens (принадлежности к аллергенам)
  - shelf_life, storage_conditions
  - substitutes (JSON заменители с коэффициентами замены)
  - localization (синонимы для регионов СНГ)

- Связь рецепт—ингредиент (RecipeIngredient):
  - recipe_id, ingredient_id
  - quantity, unit (грамм, мл, шт, чашка и др.)
  - preparation (измельчить, очистить и пр.)

- Категории и теги:
  - Иерархия категорий: кухня/регион → подкатегория
  - Теги: техника (запекание, жарка), прием пищи, сезон, праздник, цена, время, сложность, диета, аллергены, оборудование

### 1.2. Классификация рецептов

- География кухни: страны СНГ (Россия, Беларусь, Казахстан, Украина и др.), Европа, Азия, Америка, Африка, Ближний Восток; поддержка множественной принадлежности.
- Таймлайн: древние государства (Шумер, Древний Египет, Эллада и др.), средневековье, новое время, современность, «современная массовая» (без выраженной истории). Источник/обоснование указывать в history.
- Диетология/КБЖУ: хранение КБЖУ и нутриентов на порцию и на 100 г; теги диет и аллергенов для совместимости с профилем пользователя.
- Прочие фильтры: время/сложность, цена порции, техника, сезонность, прием пищи, оборудование.

### 1.3. API Recipe Service (черновик)

- GET /recipes — поиск и фильтрация (q, tags[], cuisine, timeline, diet[], allergens_exclude[], time_max, price_segment, sort=popularity|rating|time)
- GET /recipes/{id} — получение карточки рецепта с ингредиентами, шагами, КБЖУ, историей
- POST /recipes — создание рецепта (админ/редактор)
- PUT /recipes/{id} — обновление рецепта (админ/редактор)
- POST /recipes/{id}/rate — оценка рецепта пользователем (1–5), review (опционально)
- POST /recipes/{id}/favorite — добавить/убрать из избранного
- GET /ingredients — поиск ингредиентов (синонимы, локализация)
- GET /taxonomy — словари категорий, тегов, аллергенов, диет, единиц измерения

Требования: консистентные схемы JSON, OpenAPI-спецификация, пагинация, лимиты, трассировка.

### 1.4. Процессы пополнения базы (ETL)

- Источники: 1000.menu, tableofgods.com, иные открытые источники, UGC; видео (TikTok/Shorts/Reels/YouTube).
- Парсинг: извлечение заголовков, списков ингредиентов (с количествами/единицами), шагов, картинок/видео, первичных метаданных.
- Нормализация: маппинг единиц измерения к стандарту, преобразование в граммы/миллилитры, унификация названий ингредиентов.
- Дедупликация: сравнение по заголовку, ингредиентам, структуре шагов, изображениям (перцептивные хэши).
- Обогащение: расчет КБЖУ, присвоение диет/аллергенов, заполнение history (при наличии источника), география, таймлайн, техника.
- Модерация: статус review → published, лог аудита.

### 1.5. UI/UX требования к карточке рецепта

- Вкладки: Обзор | Ингредиенты | Шаги | КБЖУ | История | Отзывы
- Доступность: мобильная адаптация; крупные кнопки; единицы измерения переключаемые (метрические/кухонные).
- Локализация: СНГ, синонимы ингредиентов, локальные единицы измерения.

## 2. Парсер рецептов (Parser Service)

Задачи: массовая загрузка базы на старте, последующая ежедневная инкрементальная выгрузка.

- Поддержка источников: сайт (HTTP), видео (API/загрузка), потенциально OCR/ASR для извлечения текста и аудио-рецептов.
- Планировщик и очередь: распределение задач, ретраи, бэкофф, лимиты по доменам.
- Антибот/правовые аспекты: соблюдение robots.txt, частоты запросов, приорити-лист на белых/серых ресурсах, хранение первичных ссылок и атрибуции.
- Модули извлечения: название, фото/видео, ингредиенты (набор {ингредиент, количество, единица}), шаги (порядок, время, техника), первичные теги.
- Дедупликация: fuzzy matching, MinHash/LSH, pHash по изображениям.
- Валидация: полнота (≥ 80% ключевых полей), базовые правила (наличие порций/времени/ингредиентов).
- Выходные данные: JSON схемы для Enrichment Service.

## 3. Обогащение и стандартизация (Data Enrichment Service)

- Нормализация единиц: конвертация cups/spoons → граммы; справочник единиц.
- Маппинг ингредиентов: словарь ингредиентов с синонимами (СНГ), разбор составных ингредиентов (смеси/соусы).
- Авторасчет КБЖУ: агрегация по ингредиентам и количествам, корректировка по термообработке (опционально коэффициенты готовки).
- Классификация: ML/правила присвоения кухонь, таймлайна, диет, аллергенов, техники.
- История: автопоиск источников (энциклопедии, кулинарные порталы) для заполнения history, ссылки на первоисточники.
- Качество: полнота полей, консистентность, метрики доверия.

## 4. Сервис аналитики и статистики (Analytics Service)

- Сбор событий: просмотры рецептов, клики, избранное, оценки, время чтения, доля дочитавших шаги, копирование списка, отправка в корзину, отказ.
- Пользовательские метрики: DAU/WAU/MAU, Retention D1/D7/D30, частота кулинарной активности, среднее время сессии, конверсия в подписку/заказ (когда появятся соответствующие сервисы).
- Метрики рецептов: популярность (просмотры/уникальные), средняя оценка, распределение оценок, «легкость», «вкус», время, стоимость порции, конверсия «прочитал → приготовил» (через прокси-сигналы).
- Отчетность: недельные отчеты на раннем этапе, далее месячные «крупные» отчеты для инвесторов; автоматическая генерация PDF/дашбордов.
- A/B тестирование: флаг-менеджер, сегментация, статистическая значимость.
- Расширение: при добавлении новых микросервисов (ИИ-диетолог, заказы, геймификация) — сбор профильных метрик, единая витрина для аналитики.

## 5. Разделение по микросервисам и ответственность

- Recipe Service (MVP): база рецептов, ингредиентов, классификация, поиск/фильтры, рейтинги/избранное, API.
- Parser Service (MVP): сбор данных из внешних источников (сайты, видео), дедупликация, базовая валидация.
- Data Enrichment Service (MVP): стандартизация, КБЖУ, диеты/аллергены, история, доп. метаданные.
- Analytics Service (MVP): события, метрики, отчеты, A/B.
- User Service: профили, предпочтения, локализация пользователя.
- Auth Service: аутентификация/авторизация, токены, роли.
- Notification Service: push/email, шаблоны, расписание.
- Payment Service: платежи/подписки, биллинг (TBD тарифы и лимиты).
- Future: AI Nutritionist (ИИ рекомендации), Meal Planning (план питания), Order Service (корзина/доставка), Gamification (ачивки, уровни).

## 6. Нефункциональные аспекты для этих микросервисов (выдержка)

- Локализация: СНГ (RU первично), синонимы ингредиентов/единиц.
- Производительность поиска: P95 ≤ 3 с; генерация карточки P95 ≤ 2 с.
- Доступность: ≥ 99.5% для Recipe/Analytics; очереди с ретраями в Parser/Enrichment.
- Масштабируемость: горизонтальная для Recipe (read-heavy), Analytics (write-heavy), очереди Kafka/RabbitMQ.
- Безопасность: OAuth2/OIDC, RBAC, audit log; персональные данные — в User/Auth.

## 7. Диаграммы и артефакты

- Архитектура микросервисов (крупные блоки, читаемые подписи):

[85]

- Use Case Recipe Service (PlantUML XMI/PUML — импортируйте в PlantUML):

[88]

- Схема БД Recipe Service (PlantUML XMI/PUML):

[87]

## 8. План отчетности и метрик

- Еженедельные отчеты (MVP-этап): конверсия поиска → просмотр карточки → добавление в избранное → копирование списка → отправка в корзину (когда появится), NPS, рейтинг рецептов, активность по кухням/таймлайну.
- Ежемесячные отчеты (с ростом): агрегаты MAU/WAU/DAU, Retention, воронки, средние рейтинги по кухням/категориям, вклад источников (сайт/видео/UGC), качество парсинга (полнота полей), валидация КБЖУ.
- Расширение при вводе новых сервисов: отдельные секции отчетов по ИИ-диетологу, заказам, геймификации.

## 9. Ограничения и TBD

- Тарифная сетка и лимиты доступа к ИИ — TBD; возможно, free с лимитами по количеству/мощности запросов.
- Правовые аспекты парсинга — отладить с юристом (условия использования, robots.txt, атрибуция).
- Источники фактов для истории блюд — указание источников и уровень доверия.
- Качество КБЖУ — выбор эталонной базы нутриентов (USDA/RUS) и калибровки.
- Видео-анализ — feasibility PoC (ASR/OCR/Computer Vision для рецептов).
