@startuml api_recipe_endpoints

!define TITLE COOKie MVP - Recipe API Endpoints
!define VERSION 1.0
!define DATE 2025-10-16

title TITLE\nVersion VERSION\nLast Updated: DATE

' Cross-references:
' - api_endpoints_overview.puml (API overview)
' - database/enhanced_database_schema.puml (recipes table schema)
' - sequence/sequence_user_search_recipe.puml (Search flow)
' - caching/cache_strategy_overview.puml (Caching details)
' - error-handling/error_codes_mapping.puml (Error responses)

skinparam componentStyle rectangle
skinparam noteStyle rectangle

component "GET /api/v1/recipes" as search {
  **Purpose**: Search and browse recipes with filters
  **Authentication**: None (üîì Public)
  **Rate Limit**: 1000 req/hour per IP
  **Cache**: Redis 5min TTL
  --
  **Query Parameters:**
  ‚Ä¢ q (string, optional): Full-text search query
    - Searches in: title, description
    - Language: Russian morphology
    - Example: "–ø–∞—Å—Ç–∞ –∫–∞—Ä–±–æ–Ω–∞—Ä–∞"

  ‚Ä¢ cuisine (string[], optional): Filter by cuisine
    - Multiple values: comma-separated
    - Example: "italian,asian"
    - Values from: GET /recipes/cuisines

  ‚Ä¢ difficulty (integer[], optional): Filter by difficulty
    - Range: 1-5 (1=easiest, 5=hardest)
    - Multiple values: comma-separated
    - Example: "1,2,3"

  ‚Ä¢ max_time (integer, optional): Max cooking time
    - Unit: minutes
    - Example: 30 (recipes ‚â§ 30 minutes)

  ‚Ä¢ dietary_tags (string[], optional): Filter by diet
    - Multiple values: comma-separated
    - Example: "vegan,gluten-free"
    - Possible values: vegan, vegetarian, keto, paleo,
      gluten-free, dairy-free, low-carb, high-protein

  ‚Ä¢ exclude_allergens (string[], optional): Exclude allergens
    - Multiple values: comma-separated
    - Example: "gluten,nuts"
    - Possible values: gluten, dairy, eggs, nuts, soy,
      fish, shellfish, sesame

  ‚Ä¢ min_rating (decimal, optional): Min average rating
    - Range: 0-5
    - Example: 4.0

  ‚Ä¢ page (integer, optional): Page number
    - Default: 1
    - Min: 1

  ‚Ä¢ per_page (integer, optional): Items per page
    - Default: 20
    - Min: 1, Max: 50

  ‚Ä¢ sort (string, optional): Sort field
    - Default: relevance (for text search) or created_at
    - Values: relevance, rating, popularity, created_at,
      total_time, difficulty

  ‚Ä¢ order (string, optional): Sort direction
    - Default: desc
    - Values: asc, desc
  --
  **Response 200 OK:**
  {
    "data": [
      {
        "id": "uuid",
        "slug": "italian-pasta-carbonara",
        "title": "–ü–∞—Å—Ç–∞ –ö–∞—Ä–±–æ–Ω–∞—Ä–∞",
        "description": "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –∏—Ç–∞–ª—å—è–Ω—Å–∫–∏–π —Ä–µ—Ü–µ–ø—Ç...",
        "cuisine_geography": ["italy"],
        "difficulty_level": 3,
        "prep_time_minutes": 15,
        "cook_time_minutes": 15,
        "total_time_minutes": 30,
        "servings": 4,
        "dietary_tags": ["high-protein"],
        "allergens": ["gluten", "dairy", "eggs"],
        "image_urls": [
          "https://cdn.cookie.com/recipes/pasta-carbonara.webp"
        ],
        "rating_avg": 4.75,
        "rating_count": 248,
        "view_count": 12456,
        "favorite_count": 892,
        "nutrition_per_serving": {
          "calories": 520,
          "protein_g": 18.5,
          "fat_g": 24.0,
          "carbs_g": 52.0,
          "fiber_g": 2.5
        },
        "created_at": "2025-01-15T10:30:00Z",
        "updated_at": "2025-10-10T14:22:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "per_page": 20,
      "total_pages": 15,
      "total_items": 287,
      "has_next": true,
      "has_prev": false
    },
    "meta": {
      "search_query": "–ø–∞—Å—Ç–∞",
      "filters_applied": {
        "cuisine": ["italian"],
        "difficulty": [1, 2, 3]
      },
      "sort": "rating",
      "order": "desc"
    }
  }
  --
  **Response 400 Bad Request:**
  {
    "type": "https://api.cookie.com/errors/validation-error",
    "title": "Validation Failed",
    "status": 400,
    "detail": "Invalid query parameters",
    "instance": "/api/v1/recipes",
    "errors": [
      {
        "field": "per_page",
        "message": "Must be between 1 and 50"
      }
    ]
  }
  --
  **Response 429 Too Many Requests:**
  {
    "type": "https://api.cookie.com/errors/rate-limit",
    "title": "Rate Limit Exceeded",
    "status": 429,
    "detail": "Too many requests, please try again later",
    "instance": "/api/v1/recipes",
    "retry_after": 3600
  }
}

component "GET /api/v1/recipes/{slug}" as details {
  **Purpose**: Get detailed recipe information
  **Authentication**: None (üîì Public)
  **Rate Limit**: 1000 req/hour per IP
  **Cache**: Redis 10min TTL
  --
  **Path Parameters:**
  ‚Ä¢ slug (string, required): Recipe URL slug
    - Format: lowercase, hyphens, no special chars
    - Example: "italian-pasta-carbonara"
  --
  **Response 200 OK:**
  {
    "id": "uuid",
    "slug": "italian-pasta-carbonara",
    "title": "–ü–∞—Å—Ç–∞ –ö–∞—Ä–±–æ–Ω–∞—Ä–∞",
    "description": "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –∏—Ç–∞–ª—å—è–Ω—Å–∫–∏–π —Ä–µ—Ü–µ–ø—Ç...",
    "history": "–ö–∞—Ä–±–æ–Ω–∞—Ä–∞ –ø–æ—è–≤–∏–ª–∞—Å—å –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ XX –≤–µ–∫–∞...",
    "cuisine_geography": ["italy"],
    "timeline_category": "modern",
    "difficulty_level": 3,
    "prep_time_minutes": 15,
    "cook_time_minutes": 15,
    "total_time_minutes": 30,
    "servings": 4,
    "instructions": [
      {
        "step_number": 1,
        "instruction": "–û—Ç–≤–∞—Ä–∏—Ç–µ —Å–ø–∞–≥–µ—Ç—Ç–∏ –≤ –ø–æ–¥—Å–æ–ª–µ–Ω–Ω–æ–π –≤–æ–¥–µ...",
        "estimated_time_minutes": 10
      },
      {
        "step_number": 2,
        "instruction": "–û–±–∂–∞—Ä—å—Ç–µ –ø–∞–Ω—á–µ—Ç—Ç—É –Ω–∞ —Å–∫–æ–≤–æ—Ä–æ–¥–µ...",
        "estimated_time_minutes": 5
      }
    ],
    "nutrition_per_serving": {
      "calories": 520,
      "protein_g": 18.5,
      "fat_g": 24.0,
      "carbs_g": 52.0,
      "fiber_g": 2.5,
      "sugar_g": 3.2,
      "sodium_mg": 680
    },
    "nutrition_per_100g": {
      "calories": 173,
      "protein_g": 6.2,
      "fat_g": 8.0,
      "carbs_g": 17.3
    },
    "dietary_tags": ["high-protein"],
    "allergens": ["gluten", "dairy", "eggs"],
    "price_segment": "medium",
    "image_urls": [
      "https://cdn.cookie.com/recipes/pasta-carbonara-main.webp",
      "https://cdn.cookie.com/recipes/pasta-carbonara-step1.webp"
    ],
    "rating_avg": 4.75,
    "rating_count": 248,
    "view_count": 12456,
    "favorite_count": 892,
    "source_url": "https://1000.menu/cooking/12345",
    "source_type": "site",
    "moderation_status": "published",
    "created_at": "2025-01-15T10:30:00Z",
    "updated_at": "2025-10-10T14:22:00Z",
    "published_at": "2025-01-16T08:00:00Z",
    "ingredients": [
      {
        "id": "uuid",
        "name": "–°–ø–∞–≥–µ—Ç—Ç–∏",
        "quantity": 400,
        "unit": "–≥",
        "order_index": 1,
        "preparation": "—Å—É—Ö–∏–µ",
        "is_optional": false
      },
      {
        "id": "uuid",
        "name": "–ü–∞–Ω—á–µ—Ç—Ç–∞",
        "quantity": 150,
        "unit": "–≥",
        "order_index": 2,
        "preparation": "–Ω–∞—Ä–µ–∑–∞–Ω–Ω–∞—è –∫—É–±–∏–∫–∞–º–∏",
        "is_optional": false
      }
    ]
  }
  --
  **Response 404 Not Found:**
  {
    "type": "https://api.cookie.com/errors/not-found",
    "title": "Recipe Not Found",
    "status": 404,
    "detail": "Recipe with slug 'unknown-recipe' does not exist",
    "instance": "/api/v1/recipes/unknown-recipe"
  }
  --
  **Side Effects:**
  - Increments view_count for the recipe
  - Sends "recipe_view" event to Analytics Service
  - Updates "last_viewed_at" for authenticated users
}

component "GET /api/v1/recipes/popular" as popular {
  **Purpose**: Get top 20 popular recipes
  **Authentication**: None (üîì Public)
  **Rate Limit**: 1000 req/hour per IP
  **Cache**: Redis 15min TTL
  --
  **Query Parameters:**
  ‚Ä¢ limit (integer, optional): Number of recipes
    - Default: 20
    - Min: 1, Max: 50

  ‚Ä¢ period (string, optional): Time period for popularity
    - Default: week
    - Values: today, week, month, all_time
  --
  **Response 200 OK:**
  {
    "data": [
      {
        "id": "uuid",
        "slug": "italian-pasta-carbonara",
        "title": "–ü–∞—Å—Ç–∞ –ö–∞—Ä–±–æ–Ω–∞—Ä–∞",
        "description": "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –∏—Ç–∞–ª—å—è–Ω—Å–∫–∏–π —Ä–µ—Ü–µ–ø—Ç...",
        "cuisine_geography": ["italy"],
        "difficulty_level": 3,
        "total_time_minutes": 30,
        "image_urls": [
          "https://cdn.cookie.com/recipes/pasta-carbonara.webp"
        ],
        "rating_avg": 4.75,
        "rating_count": 248,
        "view_count": 12456,
        "favorite_count": 892,
        "popularity_score": 985.5
      }
    ],
    "meta": {
      "period": "week",
      "algorithm": "weighted_popularity",
      "last_updated": "2025-10-16T12:00:00Z"
    }
  }
  --
  **Popularity Algorithm:**
  popularity_score = (view_count * 0.4) +
                     (favorite_count * 0.3) +
                     (rating_avg * rating_count * 0.3)
}

component "GET /api/v1/recipes/cuisines" as cuisines {
  **Purpose**: Get list of all available cuisines
  **Authentication**: None (üîì Public)
  **Rate Limit**: 1000 req/hour per IP
  **Cache**: Redis 1hour TTL
  --
  **Response 200 OK:**
  {
    "data": [
      {
        "cuisine": "italian",
        "display_name": "–ò—Ç–∞–ª—å—è–Ω—Å–∫–∞—è",
        "recipe_count": 245
      },
      {
        "cuisine": "asian",
        "display_name": "–ê–∑–∏–∞—Ç—Å–∫–∞—è",
        "recipe_count": 187
      },
      {
        "cuisine": "russian",
        "display_name": "–†—É—Å—Å–∫–∞—è",
        "recipe_count": 156
      }
    ],
    "total_cuisines": 28
  }
  --
  **Notes:**
  - Only cuisines with at least 1 published recipe
  - Sorted by recipe_count descending
  - Cached for 1 hour (low volatility)
}

note right of search
  **Full-Text Search Details:**
  - PostgreSQL tsvector with Russian morphology
  - Searches: title, description fields
  - Relevance ranking using ts_rank
  - Supports synonyms via thesaurus
  - Auto-suggestion via trigram similarity

  **Performance:**
  - Indexed: idx_recipes_fulltext (GIN)
  - Query time P95: < 100ms
  - Cached results: 5 minutes
end note

note right of details
  **Recipe Detail Response:**
  - Full recipe object (all fields)
  - Includes ingredients with order
  - Includes step-by-step instructions
  - Includes complete nutrition data
  - Includes historical context

  **Caching Strategy:**
  - Cache key: recipe:slug:{slug}
  - TTL: 10 minutes
  - Invalidate on recipe update
end note

note bottom of popular
  **Popularity Ranking:**
  - Calculated via background job (hourly)
  - Weighted formula considers:
    40% view count
    30% favorite count
    30% rating quality
  - Cached for 15 minutes
  - Separate rankings per time period
end note

@enduml
